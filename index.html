<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <!-- Bootstrap -->
    <link
      rel="stylesheet"
      href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css"
      integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T"
      crossorigin="anonymous"
    />
    <script
      src="https://code.jquery.com/jquery-3.3.1.slim.min.js"
      integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo"
      crossorigin="anonymous"
    ></script>
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"
      integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1"
      crossorigin="anonymous"
    ></script>
    <script
      src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"
      integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM"
      crossorigin="anonymous"
    ></script>
    <!-- numjs -->
    <script src="https://cdn.jsdelivr.net/gh/nicolaspanel/numjs@0.15.1/dist/numjs.min.js"></script>
    <title>Gauss Seidel</title>
  </head>
  <body>
    <main id="app" class="container">
      <h1 class="mb-5 mt-4">MÃ©todo Gauss - Seidel</h1>

      <p>Cantidad de filas y columnas</p>
      <input type="number" v-model="columFilas" class="mb-4" />
      <button v-on:click="hacerTabla">Crear matriz</button>

      <div class="container">
        <div class="row d-flex justify-content-start align-items-center">
          <table v-if="tablaCreada">
            <th>Matriz</th>
            <tr v-for="(i, indexi) in vectorMatrixUI">
              <td v-for="(j, indexj) in vectorMatrixUI">
                <input
                  type="number"
                  style="width: 90px;"
                  @blur="seleccionarValorMatriz({indexi, indexj, $event})"
                />
              </td>
            </tr>
          </table>

          <table v-if="tablaCreada" class="ml-3">
            <th>Vector Solucion</th>
            <tr v-for="(i, indexi) in vectorMatrixUI">
              <td>
                <input
                  type="number"
                  style="width: 90px;"
                  @blur="seleccionarValorRespuesta({indexi, $event})"
                />
              </td>
            </tr>
          </table>
        </div>
      </div>

      <div class="container">
        <div class="row mt-3" v-if="tablaCreada">
          <div class="input-group mb-3 w-50 h-50">
            <div class="input-group-prepend">
              <span class="input-group-text" id="inputGroup-sizing-small"
                >Tolerancia</span
              >
            </div>
            <input
              type="number"
              step="0.01"
              name="tolerancia"
              class="form-control"
              aria-label="Sizing example input"
              aria-describedby="inputGroup-sizing-default"
              v-model="tolerancia"
              @blur="obtenerTolerancia({$event})"
            />
          </div>
        </div>
        <div class="row" v-if="tablaCreada">
          <button
            :disabled="!poderEnviar"
            v-on:click="enviar"
            class="mt-4 d-block btn btn-success"
          >
            Enviar
          </button>
        </div>
      </div>

      <div class="container" v-if="mostrarResultados">
        <div class="row mt-5"><h1>Respuestas</h1></div>
        <div class="row mt-4">
          <h2>Cantidad de iteraciones: {{ iteracion }}</h2>
        </div>
        <div class="row mt-3">
          <h3>Errores</h3>
        </div>
        <div class="row" v-for="i in erroresAnteriores">
          <div class="col">
            <h5>x{{ i.variable + 1 }}</h5>
          </div>
          <div class="col">
            <h5>{{ i.error.toFixed(5) }}%</h5>
          </div>
        </div>
        <div class="row mt-3">
          <h3>Respuestas aproximadas</h3>
        </div>
        <div class="row" v-for="(j, index) in respuestasFinales">
          <div class="col">
            <h4>x{{ index + 1 }}</h4>
          </div>
          <div class="col">
            <h4>{{ j.toFixed(5) }}</h4>
          </div>
        </div>
      </div>
    </main>

    <script type="module">
      import Vue from 'https://cdn.jsdelivr.net/npm/vue@2.6.10/dist/vue.esm.browser.js'
    </script>
    <script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>
    <script>
      const app = new Vue({
        el: '#app',
        data: {
          columFilas: 0,
          vectorMatrixUI: [] /* UI */,
          array: [],
          vectorSolucion: [],
          erroresAnteriores: [],
          respuestasFinales: [],
          tablaCreada: false,
          poderEnviar: false,
          tolerancia: 0,
          iteracion: 0,
          mostrarResultados: false
        },
        methods: {
          hacerTabla: function() {
            if (this.columFilas !== '' && this.columFilas !== 0) {
              for (var i = 0; i < this.columFilas; i++) {
                this.vectorMatrixUI[i] = 0
              }
              this.tablaCreada = true
            }
          },
          seleccionarValorMatriz(obj) {
            let { indexi: i, indexj: j, $event: e } = obj
            if (e.target.value === '') {
              console.log('No has establecido un valor')
            } else {
              let valor = { fila: i, colum: j, valor: e.target.value }
              let repetido = this.array.filter(el =>
                this.validarExistenciaValorMatriz(el, i, j)
              )
              if (repetido.length > 0) {
                this.array.forEach(el => {
                  if (el.fila === i && el.colum === j) {
                    el.valor = e.target.value
                  }
                })
              } else {
                this.array.push(valor)
              }
              console.log('valores matriz', this.array)
            }
            this.desbloquearBoton()
          },
          seleccionarValorRespuesta(obj) {
            let { indexi: i, $event: e } = obj
            if (e.target.value === '') {
              console.log('No has establecido un valor')
            } else {
              let valor = { fila: i, valor: e.target.value }
              let repetido = this.vectorSolucion.filter(el =>
                this.validarExistenciaValorVector(el, i)
              )
              if (repetido.length > 0) {
                this.vectorSolucion.forEach(el => {
                  if (el.fila === i) {
                    el.valor = e.target.value
                  }
                })
              } else {
                this.vectorSolucion.push(valor)
              }
            }
            this.desbloquearBoton()
          },
          validarExistenciaValorMatriz(el, i, j) {
            return i === el.fila && j === el.colum
          },
          validarExistenciaValorVector(el, i) {
            return i === el.fila
          },
          obtenerTolerancia(obj) {
            let { $event: e } = obj
            this.tolerancia = parseFloat(e.target.value)
            this.desbloquearBoton()
          },
          desbloquearBoton() {
            if (
              this.vectorSolucion.length === parseInt(this.columFilas) &&
              this.array.length ===
                parseInt(this.columFilas * this.columFilas) &&
              this.tolerancia !== 0
            ) {
              this.poderEnviar = true
            } else {
              this.poderEnviar = false
            }
          },
          organizarMatriz() {
            // Primero acomodarlos por fila
            let largo = this.array.length
            let nuevoArray = []
            // Acomodar por fila
            for (let i = 0; i < largo; i++) {
              for (let j = 0; j < largo; j++) {
                //console.log('j', j)
                if (this.array[j].fila === i) {
                  //console.log('this.array[j]', this.array[j])
                  nuevoArray.push(this.array[j])
                }
              }
            }
            console.log(nuevoArray)
            // Acomodo de array para que los numeros esten como en la matriz introducida
            let arrayFinal = []
            let arrayAux = []
            let numAux = 0
            for (let i = 0; i < this.columFilas; i++) {
              for (let j = 0; j < this.columFilas; j++) {
                arrayAux = nuevoArray.filter(el => {
                  return el.colum === j && el.fila === i
                })
                numAux = arrayAux[0].valor
                arrayFinal.push(numAux)
              }
            }
            console.log('ARRAY FINAL', arrayFinal)
            return arrayFinal
          },
          organizarVector() {
            let arrayVector = []
            for (let i = 0; i < this.vectorSolucion.length; i++) {
              arrayVector.push(this.vectorSolucion[i])
            }
            let arrayVectorMap = []
            for (let j = 0; j < this.vectorSolucion.length; j++) {
              for (let g = 0; g < this.vectorSolucion.length; g++) {
                if (arrayVector[g].fila === j) {
                  arrayVectorMap.push(arrayVector[g].valor)
                  break
                }
              }
            }
            return arrayVectorMap
          },
          enviar() {
            console.log('HACIENDO CALCULO')
            let arrayFinal = this.organizarMatriz()
            let vectorSol = this.organizarVector()

            // Utilizando libreria numjs
            let npArray = nj.array(arrayFinal)
            let matrix = npArray.reshape(this.columFilas, this.columFilas)
            console.log('matrix', matrix)
            this.gaussSeidel(matrix, vectorSol)
          },
          gaussSeidel(matrix, vectorAcomodado) {
            let vector = nj.array(vectorAcomodado)
            // console.log('VECTOR', vector)
            let x = nj.zeros(parseInt(this.columFilas))
            let comp = nj.zeros(this.columFilas)
            //console.log('comp', comp)
            // metodo
            let k = 0 //iteraciones
            let tolerancia = this.tolerancia
            let continuar = true
            let arrayErrores = []
            while (continuar) {
              let suma = 0
              console.log('Iteracion ', k + 1)
              k = k + 1
              comp = x.clone()
              let erroresAnteriores = []
              for (let r = 0; r < this.columFilas; r++) {
                suma = 0
                console.log('errores anteriores', erroresAnteriores)
                for (let c = 0; c < this.columFilas; c++) {
                  if (c != r) {
                    suma = suma + matrix.get(r, c) * x.get(c)
                  }
                }
                let opDespeje = (vector.get(r) - suma) / matrix.get(r, r)
                x.set(r, opDespeje)
                console.log('x' + (r + 1) + ': ' + x.get(r) + '\n')
                let error = this.errorIteracionAnterior(x.get(r), comp.get(r))
                arrayErrores.push({ iteracion: k, variable: r, error: error })
                erroresAnteriores.push({ variable: r, error: error })
                console.log('errores anteriores ahora', erroresAnteriores)
              }
              let arrayPrueba = arrayErrores.filter(
                value => value.iteracion === k && value.error < tolerancia
              )
              this.iteracion = k
              this.erroresAnteriores = erroresAnteriores
              console.log('arrayPrueba', arrayPrueba)
              this.respuestasFinales = x.selection.data
              console.log('respuestas finales', x.selection.data)
              console.log('respuestas finales typeof', typeof x.selection.data)
              if (arrayPrueba.length === parseInt(this.columFilas)) {
                console.log('Ya todos estan abajo de tolerancia')
                continuar = false
              }
            }
            x = 0
            this.mostrarResultados = true
          },
          errorIteracionAnterior(valorActual, valorAnterior) {
            return Math.abs((valorActual - valorAnterior) / valorActual) * 100
          }
        } // Fin de methods
      })
    </script>
  </body>
</html>
